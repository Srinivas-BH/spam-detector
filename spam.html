<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spam / Ham Analyzer</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 18px; background:#f6f8fa; color:#111; }
    .container { max-width: 980px; margin: 0 auto; }
    h1 { margin-bottom: 6px; }
    .card { background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 6px 18px rgba(20,20,30,0.06); margin-bottom: 16px; }
    textarea { width:100%; min-height:140px; padding:10px; font-size:14px; border-radius:8px; border:1px solid #dfe4ea; resize:vertical; }
    .row { display:flex; gap:12px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    button { background:#0b5fff; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .results { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .small { font-size:13px; color:#555; }
    .alg-list { margin-top:12px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; }
    .alg-item { background:#fafbff; padding:10px; border-radius:8px; border:1px solid #eef2ff; }
    .legend-dot { width:11px; height:11px; border-radius:50%; display:inline-block; margin-right:8px; vertical-align:middle; }
    .center { text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Spam / Ham Analyzer</h1>
    <p class="small">Paste your message below. The page will show each model's ham% (X) vs spam% (Y) and plot them for visual analysis.</p>

    <div class="card">
      <label for="message"><strong>Message</strong></label>
      <textarea id="message" placeholder="Paste or write the message to analyze..."></textarea>

      <div class="row">
        <button id="analyzeBtn">Analyze</button>
        <button id="clearBtn" style="background:#e6e9ef;color:#111">Clear</button>
        <div class="small" id="status" style="margin-left:8px"></div>
      </div>

      <div class="results" id="summary" aria-live="polite"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0">Ham (X-axis) vs Spam (Y-axis)</h3>
      <canvas id="scatterChart" width="800" height="400"></canvas>
      <p class="small center" style="margin-top:8px">Each point = an algorithm's scores. Consensus is shown as a larger star point.</p>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0">Per-algorithm breakdown</h3>
      <div id="algList" class="alg-list"></div>
    </div>

  </div>

<script>
  const analyzeBtn = document.getElementById('analyzeBtn');
  const clearBtn = document.getElementById('clearBtn');
  const messageEl = document.getElementById('message');
  const statusEl = document.getElementById('status');
  const summaryEl = document.getElementById('summary');
  const algListEl = document.getElementById('algList');

  // Setup Chart.js scatter chart
  const ctx = document.getElementById('scatterChart').getContext('2d');

  const scatterConfig = {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Algorithms',
          data: [], // {x: ham%, y: spam%, r: size, name: 'logistic_regression'}
          pointStyle: 'circle',
          pointRadius: 6,
          backgroundColor: 'rgba(11,95,255,0.9)',
        },
        {
          label: 'Consensus',
          data: [],
          pointStyle: 'star',
          pointRadius: 10,
          backgroundColor: 'rgba(255,99,71,0.95)',
        }
      ]
    },
    options: {
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const d = context.raw;
              return `${d.name || 'point'} â€” Ham: ${d.x.toFixed(2)}%, Spam: ${d.y.toFixed(2)}%`;
            }
          }
        },
        legend: { display: true }
      },
      scales: {
        x: {
          title: { display: true, text: 'Ham (%)' },
          min: 0, max: 100
        },
        y: {
          title: { display: true, text: 'Spam (%)' },
          min: 0, max: 100
        }
      }
    }
  };

  const scatterChart = new Chart(ctx, scatterConfig);

  function setStatus(text, isError=false) {
    statusEl.textContent = text || '';
    statusEl.style.color = isError ? 'crimson' : '#333';
  }

  analyzeBtn.addEventListener('click', async () => {
    const text = messageEl.value.trim();
    if (!text) {
      setStatus('Please enter a message to analyze.', true);
      return;
    }
    setStatus('Analyzing...');
    analyzeBtn.disabled = true;

    try {
      const resp = await fetch('/predict-all', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message: text})
      });

      const data = await resp.json();
      if (!data.ok) {
        setStatus('Server error: ' + (data.error || 'unknown'), true);
        analyzeBtn.disabled = false;
        return;
      }

      // Clear previous UI
      summaryEl.innerHTML = '';
      algListEl.innerHTML = '';
      scatterChart.data.datasets[0].data = [];
      scatterChart.data.datasets[1].data = [];

      // Show consensus on top
      const consensus = data.consensus || null;
      if (consensus) {
        const hamPct = consensus.ham_score * 100;
        const spamPct = consensus.spam_score * 100;
        // show summary
        const s = document.createElement('div');
        s.className = 'card';
        s.innerHTML = `<strong>Consensus: ${consensus.label.toUpperCase()}</strong>
                       <div class="small">Ham: ${(hamPct).toFixed(2)}% &nbsp; | &nbsp; Spam: ${(spamPct).toFixed(2)}%</div>`;
        summaryEl.appendChild(s);

        // add consensus point
        scatterChart.data.datasets[1].data.push({x: hamPct, y: spamPct, name: 'consensus'});
      }

      // Add each algorithm point
      const algoResults = data.algorithms || {};
      Object.keys(algoResults).forEach((algName, idx) => {
        const r = algoResults[algName];
        const hamPct = r.ham_score * 100;
        const spamPct = r.spam_score * 100;

        // small card per algorithm
        const div = document.createElement('div');
        div.className = 'alg-item';
        div.innerHTML = `<strong style="text-transform:capitalize">${algName.replace(/_/g,' ')}</strong>
                         <div class="small">Label: <b>${r.label}</b></div>
                         <div class="small">Ham: ${(hamPct).toFixed(2)}% &nbsp; | &nbsp; Spam: ${(spamPct).toFixed(2)}%</div>`;
        algListEl.appendChild(div);

        // scatter point
        scatterChart.data.datasets[0].data.push({x: hamPct, y: spamPct, name: algName});
      });

      scatterChart.update();

      setStatus('Analysis complete.');
    } catch (err) {
      console.error(err);
      setStatus('Unexpected error: ' + err.message, true);
    } finally {
      analyzeBtn.disabled = false;
    }
  });

  clearBtn.addEventListener('click', () => {
    messageEl.value = '';
    summaryEl.innerHTML = '';
    algListEl.innerHTML = '';
    scatterChart.data.datasets[0].data = [];
    scatterChart.data.datasets[1].data = [];
    scatterChart.update();
    setStatus('');
  });

  // Allow Enter+Ctrl to analyze quickly
  messageEl.addEventListener('keydown', (e) => {
    if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
      analyzeBtn.click();
    }
  });
</script>
</body>
</html>
